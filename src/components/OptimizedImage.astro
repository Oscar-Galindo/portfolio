---
import { getResponsiveImageSet, getPlaceholderImage } from '../lib/cloudinary-proxy';

export interface Props {
  src: string;
  alt: string;
  sizes?: number[];
  aspectRatio?: string;
  class?: string;
  loading?: 'lazy' | 'eager';
  priority?: boolean;
}

const {
  src,
  alt,
  sizes = [400, 800, 1200],
  aspectRatio = '16:9',
  class: className = '',
  loading = 'lazy',
  priority = false
} = Astro.props;

const imageSet = getResponsiveImageSet(src, sizes, {
  aspectRatio,
  crop: 'fill',
  gravity: 'auto'
});

const placeholder = getPlaceholderImage(src);
---

<div class={`image-container ${className}`} data-aspect-ratio={aspectRatio}>
  <img
    src={imageSet.src}
    srcset={imageSet.srcset}
    sizes={imageSet.sizes}
    alt={alt}
    loading={priority ? 'eager' : loading}
    decoding={priority ? 'sync' : 'async'}
    fetchpriority={priority ? 'high' : 'auto'}
    class="optimized-image"
    style={`background-image: url(${placeholder}); background-size: cover;`}
  />
</div>

<style>
  .image-container {
    position: relative;
    width: 100%;
    overflow: hidden;
  }

  .image-container[data-aspect-ratio="16:9"] {
    padding-bottom: 56.25%;
  }

  .image-container[data-aspect-ratio="4:3"] {
    padding-bottom: 75%;
  }

  .image-container[data-aspect-ratio="1:1"] {
    padding-bottom: 100%;
  }

  .optimized-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    background-color: #1a1a1a;
    background-repeat: no-repeat;
    background-position: center;
  }

  /* Fade in when loaded */
  .optimized-image {
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
  }

  .optimized-image[src] {
    opacity: 1;
  }
</style>

<script>
  // Progressive loading enhancement
  document.addEventListener('DOMContentLoaded', () => {
    const images = document.querySelectorAll('.optimized-image');

    images.forEach(img => {
      if (img.complete) {
        img.style.opacity = '1';
      } else {
        img.addEventListener('load', () => {
          img.style.opacity = '1';
        });
      }
    });
  });
</script>